# PropertyGuru Pipeline é¡¹ç›®ç»“æ„

## ğŸ“ æ–‡ä»¶è¯´æ˜

```
propertyguru_pipeline/
â”‚
â”œâ”€â”€ propertyguru_pipeline.py    # ä¸»ç¨‹åºæ–‡ä»¶ï¼ˆæ ¸å¿ƒä»£ç ï¼‰
â”œâ”€â”€ examples.py                  # ç¤ºä¾‹è¿è¡Œè„šæœ¬
â”œâ”€â”€ config.ini                   # é…ç½®æ–‡ä»¶æ¨¡æ¿
â”œâ”€â”€ README.md                    # è¯¦ç»†ä½¿ç”¨è¯´æ˜
â”‚
â”œâ”€â”€ data/                        # æ•°æ®ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ propertyguru_integrated.db  # SQLiteæ•°æ®åº“
â”‚   â”œâ”€â”€ html/                    # HTMLåŸå§‹æ–‡ä»¶
â”‚   â”œâ”€â”€ json/                    # JSONæ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ export/                  # CSVå¯¼å‡ºæ–‡ä»¶
â”‚       â”œâ”€â”€ propertyguru_export_*.csv
â”‚       â”œâ”€â”€ propertyguru_rent_*.csv
â”‚       â”œâ”€â”€ propertyguru_sale_*.csv
â”‚       â””â”€â”€ propertyguru_stats_*.json
â”‚
â””â”€â”€ logs/                        # æ—¥å¿—ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
    â””â”€â”€ propertyguru_pipeline.log
```

## ğŸš€ æ ¸å¿ƒæ”¹è¿›ç‚¹

### 1. ä»£ç æ•´åˆ
- âœ… å°† step_1.py å’Œ step_2.py æ•´åˆåˆ°ä¸€ä¸ªæ–‡ä»¶
- âœ… ç»Ÿä¸€æ•°æ®åº“æ“ä½œæ¥å£
- âœ… ç»Ÿä¸€é…ç½®ç®¡ç†

### 2. å¤šçº¿ç¨‹æ”¯æŒ
- âœ… Step 2 æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘
- âœ… çº¿ç¨‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œï¼ˆä½¿ç”¨Lockï¼‰
- âœ… å¯é…ç½®çš„çº¿ç¨‹æ± å¤§å°

### 3. åŠŸèƒ½å¢å¼º
- âœ… æ”¯æŒçµæ´»çš„Pipelineæµç¨‹æ§åˆ¶
- âœ… å¯ç‹¬ç«‹è¿è¡Œå„ä¸ªæ­¥éª¤
- âœ… æ™ºèƒ½å¢é‡æ›´æ–°ç­–ç•¥
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 4. æ€§èƒ½ä¼˜åŒ–
- âœ… å¤šçº¿ç¨‹æå‡Step 2å¤„ç†é€Ÿåº¦ï¼ˆ5-30å€ï¼‰
- âœ… æ•°æ®åº“æ“ä½œä¼˜åŒ–
- âœ… æ—©åœæœºåˆ¶å‡å°‘æ— æ•ˆè¯·æ±‚

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### Step 2 å¤„ç†é€Ÿåº¦å¯¹æ¯”

å‡è®¾æœ‰ 10,000 æ¡è®°å½•éœ€è¦è·å–ä»£ç†ä¿¡æ¯ï¼š

| çº¿ç¨‹æ•° | æ¯æ¡è€—æ—¶ | æ€»è€—æ—¶ | ç›¸å¯¹é€Ÿåº¦ |
|-------|---------|--------|---------|
| 1ï¼ˆåŸç‰ˆï¼‰| 2ç§’ | ~5.5å°æ—¶ | 1x |
| 5 | 2ç§’ | ~1.1å°æ—¶ | 5x |
| 10 | 2ç§’ | ~33åˆ†é’Ÿ | 10x |
| 20 | 2ç§’ | ~17åˆ†é’Ÿ | 20x |
| 30 | 2ç§’ | ~11åˆ†é’Ÿ | 30x |

*æ³¨ï¼šå®é™…é€Ÿåº¦å–å†³äºç½‘ç»œã€æœåŠ¡å™¨æ€§èƒ½ç­‰å› ç´ *

## ğŸ”§ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤1: å®‰è£…ä¾èµ–

```bash
pip install requests loguru func-timeout urllib3 pandas
```

### æ­¥éª¤2: é…ç½®API

ç¼–è¾‘ `propertyguru_pipeline.py` æˆ–åœ¨ä»£ç ä¸­è®¾ç½®ï¼š

```python
pipeline.apikey = 'YOUR_API_KEY'
pipeline.proxy = 'YOUR_PROXY'
```

### æ­¥éª¤3: è¿è¡Œç¨‹åº

```bash
# æ–¹å¼1: ç›´æ¥è¿è¡Œä¸»ç¨‹åº
python propertyguru_pipeline.py

# æ–¹å¼2: è¿è¡Œç¤ºä¾‹è„šæœ¬
python examples.py
```

## ğŸ’¡ æ ¸å¿ƒç±»æ–¹æ³•

### PropertyGuruPipeline ç±»

#### åˆå§‹åŒ–æ–¹æ³•
```python
__init__(max_workers=5)  # åˆ›å»ºPipelineå®ä¾‹
```

#### Step 1 æ–¹æ³•
```python
step1_crawl_listings(mode='smart_incremental')  # çˆ¬å–åˆ—è¡¨é¡µ
crawl_category(category, start_page, end_page, incremental=True)  # çˆ¬å–åˆ†ç±»
```

#### Step 2 æ–¹æ³•
```python
step2_crawl_agent_info(mode='incremental', expiry_days=None)  # çˆ¬å–ä»£ç†ä¿¡æ¯
process_records_multithread(url_paths, force_update=False)  # å¤šçº¿ç¨‹å¤„ç†
process_single_record(url_path, force_update=False)  # å¤„ç†å•æ¡è®°å½•
```

#### å·¥å…·æ–¹æ³•
```python
export_csv()  # å¯¼å‡ºCSV
get_incomplete_records()  # è·å–ä¸å®Œæ•´è®°å½•
get_expired_records(days=None)  # è·å–è¿‡æœŸè®°å½•
```

#### ä¸»æµç¨‹
```python
run_pipeline(
    step1_mode='smart_incremental',
    step2_mode='incremental',
    step2_expiry_days=None,
    skip_step1=False,
    skip_step2=False
)
```

## ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯A: é¦–æ¬¡ä½¿ç”¨
```python
# 1. å…¨é‡çˆ¬å–åˆ—è¡¨
pipeline.run_pipeline(step1_mode='full', skip_step2=True)

# 2. å¤šçº¿ç¨‹è·å–ä»£ç†ä¿¡æ¯
pipeline.run_pipeline(step2_mode='incremental', skip_step1=True)
```

### åœºæ™¯B: æ—¥å¸¸ç»´æŠ¤
```python
# æ¯å¤©è¿è¡Œï¼Œè‡ªåŠ¨å¢é‡æ›´æ–°
pipeline.run_pipeline(
    step1_mode='smart_incremental',
    step2_mode='incremental'
)
```

### åœºæ™¯C: å®šæœŸç»´æŠ¤
```python
# æ¯å‘¨æ›´æ–°è¿‡æœŸæ•°æ®
pipeline.run_pipeline(
    step2_mode='expired',
    step2_expiry_days=7,
    skip_step1=True
)
```

## ğŸ“ˆ æ•°æ®æµç¨‹å›¾

```
å¼€å§‹
  â†“
[é…ç½®Pipeline] â†’ è®¾ç½®çº¿ç¨‹æ•°ã€APIå¯†é’¥
  â†“
[Step 1: åˆ—è¡¨çˆ¬å–] â†’ å•çº¿ç¨‹é¡ºåºçˆ¬å–
  â”œâ”€ æ£€æŸ¥è¿›åº¦
  â”œâ”€ æ™ºèƒ½å¢é‡/å…¨é‡
  â”œâ”€ æ—©åœæœºåˆ¶
  â””â”€ ä¿å­˜åŸºæœ¬ä¿¡æ¯
  â†“
[Step 2: ä»£ç†ä¿¡æ¯] â†’ å¤šçº¿ç¨‹å¹¶å‘çˆ¬å–
  â”œâ”€ æŸ¥è¯¢ä¸å®Œæ•´è®°å½•
  â”œâ”€ çº¿ç¨‹æ± åˆ†é…ä»»åŠ¡
  â”œâ”€ å¹¶å‘è·å–è¯¦æƒ…
  â””â”€ æ›´æ–°ä»£ç†ä¿¡æ¯
  â†“
[æ•°æ®å¯¼å‡º] â†’ ç”ŸæˆCSVæ–‡ä»¶
  â”œâ”€ å…¨é‡æ•°æ®
  â”œâ”€ ç§Ÿæˆ¿æ•°æ®
  â”œâ”€ ä¹°æˆ¿æ•°æ®
  â””â”€ ç»Ÿè®¡ä¿¡æ¯
  â†“
å®Œæˆ
```

## ğŸ” çº¿ç¨‹å®‰å…¨è®¾è®¡

### æ•°æ®åº“æ“ä½œé”
```python
self.db_lock = Lock()

# æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½ä½¿ç”¨é”
with self.db_lock:
    conn = sqlite3.connect(self.db_path)
    # ... æ•°æ®åº“æ“ä½œ
    conn.close()
```

### çº¿ç¨‹æ± ç®¡ç†
```python
with ThreadPoolExecutor(max_workers=self.max_workers) as executor:
    # æäº¤ä»»åŠ¡
    futures = {executor.submit(task, arg): arg for arg in args}
    
    # å¤„ç†ç»“æœ
    for future in as_completed(futures):
        result = future.result()
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹æ•°é‡**: æ ¹æ®æœºå™¨æ€§èƒ½å’Œç½‘ç»œå¸¦å®½é€‰æ‹©åˆé€‚çš„çº¿ç¨‹æ•°
2. **APIé™åˆ¶**: æ³¨æ„APIçš„è°ƒç”¨é¢‘ç‡å’Œä½™é¢é™åˆ¶
3. **æ•°æ®å¤‡ä»½**: å®šæœŸå¤‡ä»½æ•°æ®åº“æ–‡ä»¶
4. **ç£ç›˜ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´å­˜å‚¨HTML/JSONæ–‡ä»¶
5. **æ—¥å¿—ç®¡ç†**: å®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è®¾ç½®æœ€ä½³çº¿ç¨‹æ•°ï¼Ÿ
**A**: å»ºè®®ä»10å¼€å§‹ï¼Œæ ¹æ®æœºå™¨æ€§èƒ½è°ƒæ•´ï¼š
- é«˜æ€§èƒ½æœåŠ¡å™¨: 20-30
- æ™®é€šç”µè„‘: 10-15
- ä½é…ç½®: 5-10

### Q2: æ•°æ®åº“é”å®šæ€ä¹ˆåŠï¼Ÿ
**A**: 
- ç¡®ä¿æ²¡æœ‰å…¶ä»–ç¨‹åºè®¿é—®æ•°æ®åº“
- å‡å°‘çº¿ç¨‹æ•°
- ä½¿ç”¨ `db_lock` ç¡®ä¿çº¿ç¨‹å®‰å…¨

### Q3: å¦‚ä½•æé«˜çˆ¬å–é€Ÿåº¦ï¼Ÿ
**A**: 
- å¢åŠ çº¿ç¨‹æ•°ï¼ˆStep 2ï¼‰
- ä½¿ç”¨æ›´å¿«çš„ä»£ç†
- ä¼˜åŒ–ç½‘ç»œç¯å¢ƒ

### Q4: å¦‚ä½•å¤„ç†å¤±è´¥çš„è®°å½•ï¼Ÿ
**A**: 
```python
# æŸ¥çœ‹å¤±è´¥è®°å½•
SELECT * FROM failed_records;

# é‡æ–°å¤„ç†ï¼ˆä¿®æ”¹ä»£ç æ·»åŠ é‡è¯•åŠŸèƒ½ï¼‰
pipeline.process_records_multithread(failed_urls, force_update=True)
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `logs/propertyguru_pipeline.log`
2. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
3. æŸ¥çœ‹READMEæ–‡æ¡£
4. æäº¤Issue

## ğŸ‰ æ€»ç»“

è¿™ä¸ªæ•´åˆåçš„Pipelineç›¸æ¯”åŸç‰ˆæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

âœ… **ç»Ÿä¸€ç®¡ç†**: ä¸€ä¸ªæ–‡ä»¶åŒ…å«æ‰€æœ‰åŠŸèƒ½
âœ… **æ€§èƒ½æå‡**: Step 2å¤šçº¿ç¨‹å¤„ç†ï¼Œé€Ÿåº¦æå‡5-30å€
âœ… **çµæ´»æ§åˆ¶**: å¯ç‹¬ç«‹è¿è¡Œå„ä¸ªæ­¥éª¤
âœ… **çº¿ç¨‹å®‰å…¨**: å®Œå–„çš„é”æœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§
âœ… **æ˜“äºä½¿ç”¨**: æ¸…æ™°çš„APIå’Œä¸°å¯Œçš„ç¤ºä¾‹
âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¤±è´¥è®°å½•å’Œé‡è¯•æœºåˆ¶
âœ… **æ—¥å¿—å®Œå–„**: è¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºè°ƒè¯•

å»ºè®®æ—¥å¸¸ä½¿ç”¨ `smart_incremental` + `incremental` æ¨¡å¼ï¼Œå®šæœŸä½¿ç”¨ `expired` æ¨¡å¼æ›´æ–°è€æ—§æ•°æ®ã€‚
